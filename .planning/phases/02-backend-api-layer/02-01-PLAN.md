---
phase: 02-backend-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/event.service.ts
  - backend/src/routes/events.router.ts
  - backend/src/middleware/validate.ts
  - backend/src/middleware/error-handler.ts
  - backend/src/types/index.ts
  - backend/src/index.ts
  - backend/package.json
autonomous: true
requirements: [API-01, API-05]

must_haves:
  truths:
    - "GET /api/events returns paginated events with envelope {data, total, page, limit}"
    - "Filters vehicleId, code, level, from, to are combinable and each narrows results correctly"
    - "Invalid query params (bad level, non-ISO date, negative page) return 400 with readable message"
    - "Unknown routes return 404 with JSON error"
    - "Unhandled server errors return 500 with JSON error, not stack trace"
    - "Undefined filter params do NOT cause TypeORM to return all rows"
  artifacts:
    - path: "backend/src/services/event.service.ts"
      provides: "Query events with dynamic filtering and pagination"
      exports: ["EventService"]
    - path: "backend/src/routes/events.router.ts"
      provides: "GET /api/events route handler"
      exports: ["eventsRouter"]
    - path: "backend/src/middleware/validate.ts"
      provides: "Generic Zod validation middleware for query params"
      exports: ["validateQuery"]
    - path: "backend/src/middleware/error-handler.ts"
      provides: "Global error handler and 404 handler"
      exports: ["errorHandler", "notFoundHandler"]
  key_links:
    - from: "backend/src/routes/events.router.ts"
      to: "backend/src/services/event.service.ts"
      via: "imports EventService, calls queryEvents()"
      pattern: "EventService"
    - from: "backend/src/routes/events.router.ts"
      to: "backend/src/middleware/validate.ts"
      via: "uses validateQuery middleware with Zod schema"
      pattern: "validateQuery"
    - from: "backend/src/index.ts"
      to: "backend/src/routes/events.router.ts"
      via: "app.use mounts eventsRouter"
      pattern: "eventsRouter"
    - from: "backend/src/index.ts"
      to: "backend/src/middleware/error-handler.ts"
      via: "app.use mounts error handlers after all routes"
      pattern: "errorHandler"
---

<objective>
Build the events query endpoint with combinable filters, pagination, input validation via Zod, and global error handling.

Purpose: Provide the primary data access API for the frontend events table — filterable by vehicleId, code, level, and time range with paginated results. Establish the validation and error handling infrastructure used by all subsequent endpoints.

Output: Working GET /api/events endpoint with Zod validation, global error handler, 404 handler.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-data-layer/01-02-SUMMARY.md
@backend/src/index.ts
@backend/src/entities/diagnostic-event.entity.ts
@backend/src/types/index.ts
@backend/src/config/database.ts
@backend/package.json
@backend/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create event service, validation middleware, and error handler</name>
  <files>
    backend/src/services/event.service.ts
    backend/src/middleware/validate.ts
    backend/src/middleware/error-handler.ts
    backend/src/types/index.ts
    backend/package.json
  </files>
  <action>
    **Install Zod:**
    Run `npm install zod` in `backend/` directory. Use Zod v4 (latest major).

    **Update types/index.ts:**
    Add response interfaces alongside existing DiagnosticLevel and ParsedLogEntry:
    - `PaginatedResponse<T>` — `{ data: T[], total: number, page: number, limit: number }`
    - `EventQueryParams` — `{ vehicleId?: string, code?: string, level?: DiagnosticLevel, from?: string, to?: string, page?: number, limit?: number }`
    Keep existing types unchanged.

    **Create backend/src/services/event.service.ts:**
    - Export class `EventService` with static method `queryEvents(params: EventQueryParams)`.
    - Use TypeORM QueryBuilder (NOT repository.findBy — it silently returns ALL rows when a field is undefined).
    - Build dynamic WHERE clauses: for each filter param, ONLY add `andWhere` if the param is defined (explicit `!== undefined` check).
      - `vehicleId` — exact match: `.andWhere('event.vehicleId = :vehicleId', { vehicleId })`
      - `code` — exact match: `.andWhere('event.code = :code', { code })`
      - `level` — exact match: `.andWhere('event.level = :level', { level })`
      - `from` — >= : `.andWhere('event.timestamp >= :from', { from })`
      - `to` — <= : `.andWhere('event.timestamp <= :to', { to })`
    - Order by `timestamp DESC`.
    - Pagination: `page` defaults to 1, `limit` defaults to 20 (max 100). Calculate `skip = (page - 1) * limit`. Use `.skip(skip).take(limit)`.
    - Use `.getManyAndCount()` to get both data array and total count in one query.
    - Return `{ data, total, page, limit }` matching PaginatedResponse type.
    - Get repository via `AppDataSource.getRepository(DiagnosticEvent)`.

    **Create backend/src/middleware/validate.ts:**
    - Export function `validateQuery(schema: ZodSchema)` that returns Express middleware `(req, res, next)`.
    - Parse `req.query` with `schema.safeParse(req.query)`.
    - On success: replace `req.query` with parsed result (coerced types), call `next()`.
    - On failure: respond 400 with `{ error: 'Validation error', details: result.error.issues }`.
    - Type the middleware properly — use `RequestHandler` from express.
    - Define Zod schemas in a separate section or export them:
      - `eventsQuerySchema` — validates:
        - `vehicleId`: optional string
        - `code`: optional string
        - `level`: optional z.enum(['ERROR', 'WARN', 'INFO'])
        - `from`: optional string matching ISO date format (use z.string().datetime() or regex validation)
        - `to`: optional string matching ISO date format
        - `page`: optional string transformed to positive integer via z.coerce.number().int().positive().default(1)
        - `limit`: optional string transformed to integer 1-100 via z.coerce.number().int().min(1).max(100).default(20)
    - Note: Query params arrive as strings, so use z.coerce for numeric fields.

    **Create backend/src/middleware/error-handler.ts:**
    - Export `notFoundHandler` — middleware that responds 404 with `{ error: 'Not found' }`.
    - Export `errorHandler` — Express error-handling middleware (4 params: err, req, res, next).
      - Log the error to console.
      - Respond with `{ error: err.message || 'Internal server error', statusCode: res.statusCode !== 200 ? res.statusCode : 500 }`.
      - Set status code to 500 if not already set to a 4xx code.
      - Do NOT expose stack traces in the response.
    - Express 5 handles async errors natively — no asyncHandler wrapper needed.
  </action>
  <verify>
    Run `cd backend && npx tsc --noEmit` — zero TypeScript errors. Verify Zod is in package.json dependencies.
  </verify>
  <done>
    event.service.ts exports EventService with queryEvents(), validate.ts exports validateQuery() with eventsQuerySchema, error-handler.ts exports errorHandler + notFoundHandler. All compile with strict TypeScript.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create events router and wire into Express app</name>
  <files>
    backend/src/routes/events.router.ts
    backend/src/index.ts
  </files>
  <action>
    **Create backend/src/routes/events.router.ts:**
    - Import `Router` from express, `EventService` from service, `validateQuery` and `eventsQuerySchema` from middleware.
    - Export `eventsRouter = Router()`.
    - `GET /api/events` — apply `validateQuery(eventsQuerySchema)` as middleware, then handler:
      - Extract validated query params from `req.query` (they are already parsed/coerced by Zod middleware).
      - Cast to `EventQueryParams` type.
      - Call `EventService.queryEvents(params)`.
      - Respond with the paginated result object.
    - Add `@openapi` JSDoc annotation above the route handler documenting:
      - Path: /api/events
      - Method: GET
      - Query parameters: vehicleId, code, level (enum), from, to, page, limit
      - 200 response with paginated event array schema
      - 400 response for validation errors
      - Tags: [Events]

    **Update backend/src/index.ts:**
    - Import `eventsRouter` from routes.
    - Import `errorHandler` and `notFoundHandler` from middleware.
    - Mount `eventsRouter` with `app.use(eventsRouter)` after healthRouter.
    - Mount `notFoundHandler` AFTER all route handlers (catches unmatched routes).
    - Mount `errorHandler` LAST (Express error handler must be last and have 4 params).
    - Keep existing healthRouter, cors, json middleware.

    **Test the endpoint manually:**
    Start the server with `cd backend && npm run dev &`, wait 3 seconds, then run these curl commands:
    - `curl http://localhost:3000/api/events` — should return paginated events (default page 1, limit 20)
    - `curl "http://localhost:3000/api/events?level=ERROR"` — should return only ERROR events
    - `curl "http://localhost:3000/api/events?vehicleId=VH-1001&level=ERROR"` — should return ERROR events for VH-1001 only
    - `curl "http://localhost:3000/api/events?level=INVALID"` — should return 400 validation error
    - `curl "http://localhost:3000/api/events?page=-1"` — should return 400 validation error
    - `curl http://localhost:3000/api/nonexistent` — should return 404
    - Kill the dev server after testing.
  </action>
  <verify>
    1. `npx tsc --noEmit` — zero errors
    2. Start server, `curl http://localhost:3000/api/events` returns `{"data":[...],"total":500,"page":1,"limit":20}` with 20 events
    3. `curl "http://localhost:3000/api/events?level=ERROR"` returns only ERROR-level events, total ~ 75
    4. `curl "http://localhost:3000/api/events?level=BAD"` returns 400 with validation error details
    5. `curl http://localhost:3000/api/notreal` returns 404 JSON
  </verify>
  <done>
    GET /api/events works with all filter combinations, returns paginated envelope, validates input with 400 on bad params, 404 on unknown routes, 500 on server errors. @openapi JSDoc annotation present on route handler.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles with zero errors (`npx tsc --noEmit`)
2. GET /api/events with no params returns 20 events, total ~500, page 1
3. GET /api/events?vehicleId=VH-1001 returns only VH-1001 events
4. GET /api/events?level=ERROR returns only ERROR events (total ~75)
5. GET /api/events?vehicleId=VH-1001&level=ERROR returns intersection (both filters applied)
6. GET /api/events?from=2025-01-15T00:00:00Z&to=2025-01-16T00:00:00Z returns time-filtered events
7. GET /api/events?page=2&limit=10 returns second page with 10 events
8. GET /api/events?level=INVALID returns 400 with validation error
9. GET /api/events?page=-1 returns 400
10. GET /api/unknown returns 404 JSON
11. Server restart does not break anything (seed guard still works)
</verification>

<success_criteria>
- Events endpoint accepts all 5 filter params and paginates correctly
- Zod validates all query params, rejects invalid values with 400
- Global error handler catches all unhandled errors and returns JSON
- 404 handler responds with JSON for unknown routes
- TypeScript strict mode — no `any` types
- @openapi JSDoc annotation present on events route
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-api-layer/02-01-SUMMARY.md`
</output>
