---
phase: 04-frontend-views
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - frontend/src/app/features/dashboard/dashboard.component.ts
  - frontend/src/app/features/dashboard/dashboard.component.html
  - frontend/src/app/features/dashboard/dashboard.component.scss
autonomous: true
requirements:
  - VIEW-04
  - VIEW-05

must_haves:
  truths:
    - "Dashboard shows summary cards with Total Events, Total Vehicles, Critical Vehicles, Most Common Code"
    - "Errors per vehicle section displays a ranked list with proportional bar widths"
    - "Top error codes section displays codes with count and severity badge"
    - "Critical vehicles section highlights vehicles and clicking navigates to /events with vehicleId pre-filled"
    - "Loading spinner appears while fetching aggregation data"
    - "FilterPanel at top allows time range filtering on aggregations"
  artifacts:
    - path: "frontend/src/app/features/dashboard/dashboard.component.ts"
      provides: "Smart DashboardComponent injecting DiagnosticsStore and Router"
      contains: "providers: [DiagnosticsStore]"
    - path: "frontend/src/app/features/dashboard/dashboard.component.html"
      provides: "Dashboard layout with summary cards, aggregation lists, critical vehicles"
      contains: "summary-cards"
    - path: "frontend/src/app/features/dashboard/dashboard.component.scss"
      provides: "Dashboard styling with card grid, bar charts, critical highlights"
  key_links:
    - from: "frontend/src/app/features/dashboard/dashboard.component.ts"
      to: "frontend/src/app/store/diagnostics.store.ts"
      via: "inject(DiagnosticsStore) + providers array"
      pattern: "providers:.*DiagnosticsStore"
    - from: "frontend/src/app/features/dashboard/dashboard.component.ts"
      to: "@angular/router"
      via: "inject(Router) for critical vehicle navigation to /events"
      pattern: "inject\\(Router\\)"
    - from: "frontend/src/app/features/dashboard/dashboard.component.html"
      to: "frontend/src/app/shared/filter-panel/filter-panel.component.ts"
      via: "template <app-filter-panel>"
      pattern: "app-filter-panel"
---

<objective>
Build the Dashboard view — a smart component at `/dashboard` that shows aggregated diagnostic summaries: summary cards, errors-per-vehicle ranked list, top error codes, and critical vehicles with click-to-navigate.

Purpose: This is the operational overview for fleet engineers. It demonstrates data aggregation visualization, cross-view navigation (critical vehicle click navigates to Events view with vehicleId pre-filled), and the smart/dumb component pattern with multiple data streams.

Output: A fully functional `DashboardComponent` replacing the current stub at `frontend/src/app/features/dashboard/`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-views/04-01-SUMMARY.md
@frontend/src/app/store/diagnostics.store.ts
@frontend/src/app/store/diagnostics-state.model.ts
@frontend/src/app/core/models/index.ts
@frontend/src/app/core/models/aggregation.model.ts
@frontend/src/styles.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement DashboardComponent with summary cards, aggregation lists, and critical vehicle navigation</name>
  <files>
    frontend/src/app/features/dashboard/dashboard.component.ts
    frontend/src/app/features/dashboard/dashboard.component.html
    frontend/src/app/features/dashboard/dashboard.component.scss
  </files>
  <action>
    Replace the existing stub `DashboardComponent` with a fully functional smart component.

    **Component file (`dashboard.component.ts`):**
    - Standalone component, `ChangeDetectionStrategy.OnPush`
    - `providers: [DiagnosticsStore]` — component-level store instance
    - `imports: [CommonModule, FilterPanelComponent, SeverityBadgeComponent, LoadingSpinnerComponent]`
    - `templateUrl: './dashboard.component.html'`, `styleUrl: './dashboard.component.scss'`
    - Inject `DiagnosticsStore` via `inject(DiagnosticsStore)`
    - Inject `Router` from `@angular/router` via `inject(Router)`
    - Expose observables: `aggregations$ = this.store.aggregations$`, `loading$ = this.store.loading$`, `filters$ = this.store.filters$`, `error$ = this.store.error$`
    - Also expose `events$` and `total$` for summary card counts (total events from the events endpoint)
    - Methods:
      - `onFiltersApply(filters: EventFilters)`: calls `this.store.setFilters(filters)` — triggers aggregation reload via store effect
      - `onFiltersReset()`: calls `this.store.resetFilters()`
      - `onCriticalVehicleClick(vehicleId: string)`: navigates to events view with vehicleId filter pre-filled:
        ```typescript
        this.router.navigate(['/events']);
        // The events view has its own store instance, so we need to pass vehicleId via query params
        // or via a shared mechanism. Simplest: use query params.
        this.router.navigate(['/events'], { queryParams: { vehicleId } });
        ```
      - `getBarWidth(count: number, maxCount: number): string` — returns CSS width as percentage: `${(count / maxCount) * 100}%` (for the proportional bar chart)
      - Compute derived data for summary cards using `map` on observables:
        - `totalVehicles$` from `aggregations$` → `agg.errorsPerVehicle.length`
        - `criticalCount$` from `aggregations$` → `agg.criticalVehicles.length`
        - `mostCommonCode$` from `aggregations$` → `agg.topCodes[0]?.code ?? 'N/A'`

    **IMPORTANT for cross-view navigation:** Since each route has its own `DiagnosticsStore` instance (component-level providers), we cannot share state between Dashboard and Events stores directly. Use `queryParams` on the router navigate call. The Events component should read `queryParams` in its constructor/`ngOnInit` and call `store.setFilters({ vehicleId })` if `vehicleId` query param is present. **Add this query param reading logic to EventsComponent** — inject `ActivatedRoute`, read `queryParams` in constructor, and apply to filters if present. This is a small addition to the events component file (add `private readonly route = inject(ActivatedRoute)` and in constructor: `this.route.queryParams.pipe(take(1)).subscribe(params => { if (params['vehicleId']) { this.store.setFilters({ vehicleId: params['vehicleId'] }); } })`).

    **Template file (`dashboard.component.html`):**
    ```
    <section class="dashboard-view">
      <h2>Fleet Health Dashboard</h2>

      <app-filter-panel
        [filters]="(filters$ | async) ?? {}"
        (filtersApply)="onFiltersApply($event)"
        (filtersReset)="onFiltersReset()">
      </app-filter-panel>

      <div class="dashboard-content">
        @if (loading$ | async) {
          <app-loading-spinner />
        }

        <!-- Summary Cards -->
        @if ((aggregations$ | async); as agg) {
          <div class="summary-cards">
            <div class="card">
              <span class="card-value">{{ (total$ | async) ?? 0 }}</span>
              <span class="card-label">Total Events</span>
            </div>
            <div class="card">
              <span class="card-value">{{ agg.errorsPerVehicle.length }}</span>
              <span class="card-label">Total Vehicles</span>
            </div>
            <div class="card card--critical">
              <span class="card-value">{{ agg.criticalVehicles.length }}</span>
              <span class="card-label">Critical Vehicles</span>
            </div>
            <div class="card">
              <span class="card-value">{{ agg.topCodes[0]?.code ?? 'N/A' }}</span>
              <span class="card-label">Most Common Code</span>
            </div>
          </div>

          <!-- Errors Per Vehicle -->
          <section class="panel">
            <h3>Errors Per Vehicle</h3>
            @if (agg.errorsPerVehicle.length > 0) {
              <ul class="bar-list">
                @for (vehicle of agg.errorsPerVehicle; track vehicle.vehicleId) {
                  <li class="bar-item">
                    <span class="bar-label">{{ vehicle.vehicleId }}</span>
                    <div class="bar-track">
                      <div class="bar-fill bar-fill--error" [style.width]="getBarWidth(vehicle.errorCount, agg.errorsPerVehicle[0].total)"></div>
                      <div class="bar-fill bar-fill--warn" [style.width]="getBarWidth(vehicle.warnCount, agg.errorsPerVehicle[0].total)"></div>
                      <div class="bar-fill bar-fill--info" [style.width]="getBarWidth(vehicle.infoCount, agg.errorsPerVehicle[0].total)"></div>
                    </div>
                    <span class="bar-count">{{ vehicle.total }}</span>
                  </li>
                }
              </ul>
            } @else {
              <p class="empty-state">No vehicle data available.</p>
            }
          </section>

          <!-- Top Error Codes -->
          <section class="panel">
            <h3>Top Error Codes</h3>
            @if (agg.topCodes.length > 0) {
              <ul class="code-list">
                @for (code of agg.topCodes; track code.code) {
                  <li class="code-item">
                    <code>{{ code.code }}</code>
                    <app-severity-badge [level]="code.level" />
                    <span class="code-count">{{ code.count }} occurrences</span>
                  </li>
                }
              </ul>
            } @else {
              <p class="empty-state">No error codes found.</p>
            }
          </section>

          <!-- Critical Vehicles -->
          <section class="panel panel--critical">
            <h3>Critical Vehicles</h3>
            @if (agg.criticalVehicles.length > 0) {
              <ul class="critical-list">
                @for (cv of agg.criticalVehicles; track cv.vehicleId) {
                  <li class="critical-item">
                    <button class="critical-link" (click)="onCriticalVehicleClick(cv.vehicleId)" [attr.aria-label]="'View events for ' + cv.vehicleId">
                      <span class="critical-vehicle-id">{{ cv.vehicleId }}</span>
                      <span class="critical-error-count">{{ cv.errorCount }} errors</span>
                      <span class="critical-latest">Latest: {{ cv.latestError | date:'short' }}</span>
                    </button>
                  </li>
                }
              </ul>
            } @else {
              <p class="empty-state">No critical vehicles detected.</p>
            }
          </section>
        }
      </div>
    </section>
    ```

    Use Angular 19 `@if`/`@for` template syntax. Import `DatePipe` in the component imports array.

    **Styles file (`dashboard.component.scss`):**
    - `.dashboard-view`: max-width 1200px, margin 0 auto, padding 24px
    - `.dashboard-content`: position relative (for spinner overlay), min-height 300px
    - `.summary-cards`: display grid, grid-template-columns repeat(auto-fit, minmax(200px, 1fr)), gap 16px, margin-top 20px
    - `.card`: background var(--surface-card), border-radius var(--radius), padding 20px, text-align center, box-shadow 0 1px 3px rgba(0,0,0,0.08)
    - `.card-value`: display block, font-size 28px, font-weight 700, color var(--text-dark), margin-bottom 4px
    - `.card-label`: display block, font-size 12px, color var(--text-secondary), text-transform uppercase, letter-spacing 0.5px
    - `.card--critical .card-value`: color var(--error)
    - `.panel`: background var(--surface-card), border-radius var(--radius), padding 20px, margin-top 20px, box-shadow 0 1px 3px rgba(0,0,0,0.08)
    - `.panel h3`: font-size 15px, margin-bottom 16px, color var(--text-dark)
    - `.panel--critical`: border-left 3px solid var(--error)
    - `.bar-list`: list-style none, padding 0, margin 0
    - `.bar-item`: display flex, align-items center, gap 12px, padding 6px 0
    - `.bar-label`: width 80px, font-size 13px, font-weight 500, flex-shrink 0
    - `.bar-track`: flex 1, height 20px, background var(--surface-main), border-radius 3px, display flex, overflow hidden
    - `.bar-fill`: height 100%, transition width 0.3s ease
    - `.bar-fill--error`: background var(--error)
    - `.bar-fill--warn`: background var(--warn)
    - `.bar-fill--info`: background var(--info)
    - `.bar-count`: width 40px, text-align right, font-size 13px, font-weight 600, color var(--text-dark)
    - `.code-list`: list-style none, padding 0, margin 0
    - `.code-item`: display flex, align-items center, gap 12px, padding 8px 0, border-bottom 1px solid var(--border-light)
    - `.code-item code`: font-family monospace, font-size 13px, background rgba(0,0,0,0.04), padding 2px 8px, border-radius 3px
    - `.code-count`: font-size 12px, color var(--text-secondary), margin-left auto
    - `.critical-list`: list-style none, padding 0, margin 0
    - `.critical-item`: margin-bottom 8px
    - `.critical-link`: display flex, align-items center, gap 16px, width 100%, padding 12px 16px, background rgba(211,47,47,0.04), border 1px solid rgba(211,47,47,0.2), border-radius var(--radius), cursor pointer, text-align left, font inherit, transition background 0.2s
    - `.critical-link:hover`: background rgba(211,47,47,0.08)
    - `.critical-vehicle-id`: font-weight 600, font-size 14px, color var(--error)
    - `.critical-error-count`: font-size 13px, color var(--text-dark)
    - `.critical-latest`: font-size 12px, color var(--text-secondary), margin-left auto
    - `.empty-state`: text-align center, padding 24px, color var(--text-secondary), font-size 14px

    **Also update EventsComponent** to read vehicleId from query params:
    In `frontend/src/app/features/events/events.component.ts`, add:
    - `import { ActivatedRoute } from '@angular/router'`
    - `import { take } from 'rxjs'`
    - `private readonly route = inject(ActivatedRoute)`
    - In constructor or with `inject()`, after store is available: read query params and apply vehicleId filter if present:
      ```typescript
      constructor() {
        this.route.queryParams.pipe(take(1)).subscribe(params => {
          const vehicleId = params['vehicleId'];
          if (vehicleId) {
            this.store.setFilters({ vehicleId });
          }
        });
      }
      ```
    This enables the critical vehicle click → events navigation flow.
  </action>
  <verify>
    Run `cd frontend && npx ng build --configuration development 2>&1 | tail -5` — must compile with zero errors.
    Verify dashboard.component.ts:
    - `providers: [DiagnosticsStore]` exists
    - `inject(Router)` exists
    - `ChangeDetectionStrategy.OnPush` is set
    Verify dashboard.component.html:
    - `summary-cards` class exists
    - `<app-filter-panel` exists
    - `critical-link` button exists
    - `<app-severity-badge` used in top codes section
    Verify events.component.ts:
    - `ActivatedRoute` is injected
    - `queryParams` is read for vehicleId
  </verify>
  <done>
    DashboardComponent displays summary cards (Total Events, Total Vehicles, Critical Vehicles, Most Common Code), errors-per-vehicle bar chart, top error codes with severity badges, and critical vehicles list. Clicking a critical vehicle navigates to `/events?vehicleId=X` and EventsComponent reads the query param to pre-fill the filter. Loading spinner and empty states for all sections. OnPush change detection. Angular build passes.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/dashboard` — summary cards show real counts from API
2. Errors per vehicle shows proportional bar chart with error/warn/info segments
3. Top error codes shows code + severity badge + occurrence count
4. Click a critical vehicle → navigates to `/events?vehicleId=VH-XXXX`
5. Events view loads with vehicleId pre-filled in filter panel and matching events shown
6. Loading spinner appears while dashboard data loads
7. FilterPanel at top of dashboard filters aggregation data by time range
8. `ng build` passes with zero TypeScript errors
</verification>

<success_criteria>
- DashboardComponent replaces stub with summary cards, aggregation lists, critical vehicles
- Cross-view navigation: critical vehicle click → `/events?vehicleId=X` → events filtered
- Smart/dumb split maintained: Dashboard injects store, shared components use @Input/@Output
- Proportional bar widths for errors-per-vehicle visualization
- Loading and empty states for all data sections
- OnPush change detection, semantic HTML, ARIA labels
- Angular build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-views/04-03-SUMMARY.md`
</output>
