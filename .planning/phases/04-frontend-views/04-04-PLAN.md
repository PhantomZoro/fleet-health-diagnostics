---
phase: 04-frontend-views
plan: 04
type: execute
wave: 3
depends_on:
  - 04-02
  - 04-03
files_modified:
  - frontend/src/app/core/interceptors/http-error.interceptor.ts
  - frontend/src/app/core/services/notification.service.ts
  - frontend/src/app/shared/toast/toast.component.ts
  - frontend/src/app/shared/toast/toast.component.scss
  - frontend/src/app/app.config.ts
  - frontend/src/app/app.component.ts
  - frontend/src/app/app.component.html
autonomous: true
requirements:
  - VIEW-05

must_haves:
  truths:
    - "HTTP errors are caught by interceptor and displayed as toast notifications"
    - "Toast notifications auto-dismiss after 5 seconds"
    - "All components use OnPush change detection"
    - "Semantic HTML elements are used throughout (main, nav, section, table)"
    - "Interactive elements have ARIA labels and keyboard navigation works"
  artifacts:
    - path: "frontend/src/app/core/interceptors/http-error.interceptor.ts"
      provides: "Functional HTTP interceptor that catches errors and pushes to NotificationService"
      contains: "HttpInterceptorFn"
    - path: "frontend/src/app/core/services/notification.service.ts"
      provides: "NotificationService with observable notification stream"
      contains: "Injectable"
    - path: "frontend/src/app/shared/toast/toast.component.ts"
      provides: "ToastComponent displaying and auto-dismissing notifications"
      contains: "ChangeDetectionStrategy.OnPush"
  key_links:
    - from: "frontend/src/app/core/interceptors/http-error.interceptor.ts"
      to: "frontend/src/app/core/services/notification.service.ts"
      via: "inject(NotificationService) in interceptor function"
      pattern: "inject\\(NotificationService\\)"
    - from: "frontend/src/app/app.config.ts"
      to: "frontend/src/app/core/interceptors/http-error.interceptor.ts"
      via: "withInterceptors([httpErrorInterceptor]) in provideHttpClient"
      pattern: "withInterceptors"
    - from: "frontend/src/app/app.component.html"
      to: "frontend/src/app/shared/toast/toast.component.ts"
      via: "<app-toast> rendered at app root level"
      pattern: "app-toast"
---

<objective>
Add HTTP error handling with toast notifications and perform a quality polish pass ensuring OnPush, semantic HTML, and ARIA compliance across all Phase 4 components.

Purpose: Error handling provides user feedback when API calls fail (network errors, 500s). The polish pass ensures the BMW coding submission demonstrates senior-level attention to accessibility, performance (OnPush), and semantic markup.

Output: HTTP error interceptor, notification service, toast component registered at app root. All components verified for OnPush, semantic HTML, ARIA labels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-views/04-02-SUMMARY.md
@.planning/phases/04-frontend-views/04-03-SUMMARY.md
@frontend/src/app/app.config.ts
@frontend/src/app/app.component.ts
@frontend/src/app/app.component.html
@frontend/src/styles.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTTP error interceptor, notification service, and toast component</name>
  <files>
    frontend/src/app/core/interceptors/http-error.interceptor.ts
    frontend/src/app/core/services/notification.service.ts
    frontend/src/app/shared/toast/toast.component.ts
    frontend/src/app/shared/toast/toast.component.scss
  </files>
  <action>
    **NotificationService** (`frontend/src/app/core/services/notification.service.ts`):
    - `@Injectable({ providedIn: 'root' })` — singleton service
    - `inject()` pattern (no constructor injection)
    - Internal state: `private readonly notificationsSubject = new BehaviorSubject<Notification[]>([])` where `Notification = { id: number, message: string, type: 'error' | 'warning' | 'info', timestamp: number }`
    - Export the `Notification` interface from this file
    - `readonly notifications$ = this.notificationsSubject.asObservable()`
    - `show(message: string, type: 'error' | 'warning' | 'info' = 'error')`: adds notification with unique `id` (use `Date.now()`) to the array
    - `dismiss(id: number)`: removes notification by id from the array
    - Auto-dismiss: in `show()`, after adding, set `setTimeout(() => this.dismiss(id), 5000)` for auto-removal after 5 seconds

    **HttpErrorInterceptor** (`frontend/src/app/core/interceptors/http-error.interceptor.ts`):
    - Export a functional interceptor: `export const httpErrorInterceptor: HttpInterceptorFn = (req, next) => { ... }`
    - `import { HttpInterceptorFn, HttpErrorResponse } from '@angular/common/http'`
    - `import { inject } from '@angular/core'`
    - `import { catchError, throwError } from 'rxjs'`
    - Inside the function: `const notifications = inject(NotificationService)`
    - Return `next(req).pipe(catchError((error: HttpErrorResponse) => { ... }))`
    - In catchError:
      - If `error.status === 0`: message = 'Unable to connect to server. Please check your connection.'
      - If `error.status >= 500`: message = `Server error (${error.status}). Please try again later.`
      - If `error.status === 400`: message = `Bad request: ${error.error?.message ?? 'Invalid parameters'}`
      - If `error.status === 404`: message = 'Resource not found.'
      - Default: message = `Request failed (${error.status})`
      - Call `notifications.show(message, 'error')`
      - Return `throwError(() => error)` to propagate the error to store's catchError

    **ToastComponent** (`frontend/src/app/shared/toast/toast.component.ts`):
    - Standalone component, `ChangeDetectionStrategy.OnPush`, inline template
    - `imports: [CommonModule]`
    - Inject `NotificationService`
    - `readonly notifications$ = this.notifications.notifications$`
    - Template:
      ```html
      <div class="toast-container" aria-live="polite">
        @for (notification of (notifications$ | async) ?? []; track notification.id) {
          <div class="toast" [class]="'toast--' + notification.type" role="alert">
            <span class="toast-message">{{ notification.message }}</span>
            <button class="toast-dismiss" (click)="dismiss(notification.id)" aria-label="Dismiss notification">&times;</button>
          </div>
        }
      </div>
      ```
    - `dismiss(id: number)`: calls `this.notifications.dismiss(id)`

    Styles file (`toast.component.scss`):
    - `.toast-container`: position fixed, top 16px, right 16px, z-index 1000, display flex, flex-direction column, gap 8px, max-width 400px
    - `.toast`: display flex, align-items center, gap 12px, padding 12px 16px, border-radius var(--radius), box-shadow 0 4px 12px rgba(0,0,0,0.15), animation `slideIn 0.3s ease-out`, font-size 13px
    - `.toast--error`: background #FDECEA, color var(--error), border-left 3px solid var(--error)
    - `.toast--warning`: background #FFF3E0, color var(--warn), border-left 3px solid var(--warn)
    - `.toast--info`: background #E3F2FD, color var(--info), border-left 3px solid var(--info)
    - `.toast-message`: flex 1
    - `.toast-dismiss`: background none, border none, font-size 18px, cursor pointer, padding 0 4px, color inherit, opacity 0.7
    - `.toast-dismiss:hover`: opacity 1
    - `@keyframes slideIn`: `from { transform: translateX(100%); opacity: 0 } to { transform: translateX(0); opacity: 1 }`
  </action>
  <verify>
    Run `cd frontend && npx ng build --configuration development 2>&1 | tail -5` — must compile with zero errors.
    Verify files exist:
    - `frontend/src/app/core/interceptors/http-error.interceptor.ts`
    - `frontend/src/app/core/services/notification.service.ts`
    - `frontend/src/app/shared/toast/toast.component.ts`
    Grep for `HttpInterceptorFn` in interceptor file.
    Grep for `BehaviorSubject` in notification service.
    Grep for `ChangeDetectionStrategy.OnPush` in toast component.
  </verify>
  <done>
    HttpErrorInterceptor catches HTTP errors with user-friendly messages by status code. NotificationService manages notification lifecycle with 5s auto-dismiss. ToastComponent renders notifications at fixed top-right position with slide-in animation and dismiss button. All files compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire interceptor into app config and add toast to app shell, plus OnPush and semantic HTML audit</name>
  <files>
    frontend/src/app/app.config.ts
    frontend/src/app/app.component.ts
    frontend/src/app/app.component.html
  </files>
  <action>
    **Update app.config.ts:**
    - Add `import { withInterceptors } from '@angular/common/http'`
    - Add `import { httpErrorInterceptor } from './core/interceptors/http-error.interceptor'`
    - Change `provideHttpClient()` to `provideHttpClient(withInterceptors([httpErrorInterceptor]))`

    **Update app.component.ts:**
    - Add `import { ToastComponent } from './shared/toast/toast.component'`
    - Add `ToastComponent` to the `imports` array

    **Update app.component.html:**
    - Add `<app-toast />` after the closing `</div>` (outside the layout, at root level)
    - This renders the toast container at app root level so notifications appear above all content

    **OnPush and semantic HTML audit:**
    After wiring the interceptor and toast, do a quick audit of ALL Phase 4 components to verify:

    1. **OnPush check** — Verify every component created in Phase 4 has `changeDetection: ChangeDetectionStrategy.OnPush`:
       - FilterPanelComponent
       - SeverityBadgeComponent
       - PaginationComponent
       - LoadingSpinnerComponent
       - EventsComponent
       - DashboardComponent
       - ToastComponent
       If any component is missing OnPush, add it.

    2. **Semantic HTML check** — Verify the following elements are used:
       - `<main>` — in app.component.html (already exists from Phase 3)
       - `<nav>` — in app.component.html (already exists), in PaginationComponent
       - `<section>` — in EventsComponent, DashboardComponent
       - `<table>` — in EventsComponent
       - `<fieldset>` + `<legend>` — in FilterPanelComponent

    3. **ARIA labels check** — Verify interactive elements have appropriate ARIA attributes:
       - Pagination buttons: `aria-label="Previous page"`, `aria-label="Next page"`
       - Filter panel inputs: `aria-label` on each input
       - Loading spinner: `role="status"`, `aria-label="Loading"`
       - Toast container: `aria-live="polite"`
       - Critical vehicle buttons: `aria-label="View events for VH-XXXX"`
       If any are missing, add them.

    4. **Keyboard navigation check** — Verify:
       - Tab order is logical through filter panel fields
       - Enter on filter inputs or Apply button triggers filter application
       - All buttons are `<button>` elements (not divs/spans with click handlers)
       If the Apply button in FilterPanel doesn't respond to Enter, add `(keydown.enter)="onApply()"` to the filter fieldset or use `<form (ngSubmit)="onApply()">` wrapping.
  </action>
  <verify>
    Run `cd frontend && npx ng build --configuration development 2>&1 | tail -5` — must compile with zero errors.
    Verify in app.config.ts: `withInterceptors` is used.
    Verify in app.component.html: `<app-toast` exists.
    Grep all Phase 4 component .ts files for `ChangeDetectionStrategy.OnPush` — all 7 should have it.
    Grep for `aria-label` in filter-panel, pagination, loading-spinner, toast templates.
    Grep for `<fieldset>` in filter-panel template.
    Grep for `<table>` in events template.
    Grep for `<section>` in events and dashboard templates.
  </verify>
  <done>
    HTTP interceptor wired into app config via `withInterceptors`. Toast component rendered at app root. All 7 Phase 4 components verified for OnPush change detection. Semantic HTML verified (main, nav, section, table, fieldset). ARIA labels present on all interactive elements. Keyboard navigation works through filter panel with Enter to apply. Angular build passes.
  </done>
</task>

</tasks>

<verification>
1. Stop backend server → attempt to load Events or Dashboard → toast appears with "Unable to connect" message
2. Toast auto-dismisses after 5 seconds
3. Click dismiss button on toast → notification removed immediately
4. `ng build` passes with zero TypeScript errors
5. All 7 Phase 4 components have `ChangeDetectionStrategy.OnPush`
6. Semantic HTML: `<main>`, `<nav>`, `<section>`, `<table>`, `<fieldset>` all present
7. ARIA labels on all interactive elements (buttons, inputs, live regions)
8. Tab through filter panel, Enter applies filters
</verification>

<success_criteria>
- HTTP errors caught and displayed as auto-dismissing toast notifications
- Interceptor registered in app config, toast component at app root
- OnPush verified on all Phase 4 components
- Semantic HTML and ARIA attributes present throughout
- Keyboard accessible: tab navigation works, Enter applies filters
- Angular build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-views/04-04-SUMMARY.md`
</output>
