<section class="events-view">
  <h2>Diagnostic Events</h2>

  <app-filter-panel
    [filters]="(filters$ | async) ?? {}"
    (filtersApply)="onFiltersApply($event)"
    (filtersReset)="onFiltersReset()">
  </app-filter-panel>

  <app-severity-legend />

  <div class="table-container">
    @if (loading$ | async) {
      <app-loading-spinner />
    }

    @if ((events$ | async); as events) {
      @if (events.length > 0) {
        <table>
          <thead>
            <tr>
              @if ((sortBy$ | async); as sortBy) {
                @if ((sortOrder$ | async); as sortOrder) {
                  <th>
                    <button class="sort-btn" [class.sort-active]="sortBy === 'timestamp'"
                      (click)="onSort('timestamp', sortBy, sortOrder)">
                      Timestamp
                      @if (sortBy === 'timestamp') {
                        <span class="sort-indicator">{{ sortOrder === 'ASC' ? '&#9650;' : '&#9660;' }}</span>
                      }
                    </button>
                  </th>
                  <th>
                    <button class="sort-btn" [class.sort-active]="sortBy === 'vehicleId'"
                      (click)="onSort('vehicleId', sortBy, sortOrder)">
                      Vehicle ID
                      @if (sortBy === 'vehicleId') {
                        <span class="sort-indicator">{{ sortOrder === 'ASC' ? '&#9650;' : '&#9660;' }}</span>
                      }
                    </button>
                  </th>
                  <th>
                    <button class="sort-btn" [class.sort-active]="sortBy === 'level'"
                      (click)="onSort('level', sortBy, sortOrder)">
                      Severity
                      @if (sortBy === 'level') {
                        <span class="sort-indicator">{{ sortOrder === 'ASC' ? '&#9650;' : '&#9660;' }}</span>
                      }
                    </button>
                  </th>
                  <th>
                    <button class="sort-btn" [class.sort-active]="sortBy === 'code'"
                      (click)="onSort('code', sortBy, sortOrder)">
                      Code
                      @if (sortBy === 'code') {
                        <span class="sort-indicator">{{ sortOrder === 'ASC' ? '&#9650;' : '&#9660;' }}</span>
                      }
                    </button>
                  </th>
                }
              }
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            @for (event of events; track event.id) {
              <tr>
                <td>{{ event.timestamp | date:'short' }}</td>
                <td class="td-vehicle"><a [routerLink]="['/vehicles', event.vehicleId]">{{ event.vehicleId }}</a></td>
                <td><app-severity-badge [level]="event.level" /></td>
                <td><code>{{ event.code }}</code></td>
                <td class="td-message">{{ event.message }}</td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        @if (!(loading$ | async)) {
          <div class="empty-state" role="status">
            <p>No events match your filters.</p>
            <p class="empty-hint">Try adjusting your search criteria or resetting filters.</p>
          </div>
        }
      }
    }
  </div>

  @if ((total$ | async); as total) {
    <app-pagination
      [total]="total"
      [page]="(page$ | async) ?? 1"
      [limit]="limit"
      (pageChange)="onPageChange($event)">
    </app-pagination>
  }
</section>
